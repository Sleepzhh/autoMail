// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model MailAccount {
  id        Int      @id @default(autoincrement())
  name      String
  type      String   // "imap" or "microsoft"
  email     String

  // IMAP fields
  imapHost  String?
  imapPort  Int?
  password  String?

  // OAuth fields
  accessToken     String?
  refreshToken    String?
  tokenExpiry     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sourceFlows AutomationFlow[] @relation("SourceAccount")
  targetFlows AutomationFlow[] @relation("TargetAccount")
}

model AutomationFlow {
  id        Int      @id @default(autoincrement())
  name      String

  sourceMailAccountId Int
  sourceMailAccount   MailAccount @relation("SourceAccount", fields: [sourceMailAccountId], references: [id], onDelete: Cascade)
  sourceMailbox       String

  targetMailAccountId Int
  targetMailAccount   MailAccount @relation("TargetAccount", fields: [targetMailAccountId], references: [id], onDelete: Cascade)
  targetMailbox       String

  enabled             Boolean  @default(true)

  // Trigger settings
  intervalMinutes     Int      @default(60)
  lastRun             DateTime?
  nextRun             DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions AutomationExecution[]
}

model AutomationExecution {
  id        Int      @id @default(autoincrement())

  flowId    Int
  flow      AutomationFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  status    String   // "success", "error", "running"
  movedCount Int     @default(0)
  errorMessage String?

  startedAt DateTime @default(now())
  completedAt DateTime?
}
